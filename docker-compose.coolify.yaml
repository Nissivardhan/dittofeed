version: "3.9"
x-clickhouse-credentials: &clickhouse-credentials
  CLICKHOUSE_USER: ${CLICKHOUSE_USER:-dittofeed}
  CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD}
x-backend-app-env: &backend-app-env
  <<: *clickhouse-credentials
  NODE_ENV: production
  DATABASE_HOST: ${DATABASE_HOST:-postgres}
  DATABASE_PORT: ${DATABASE_PORT:-5432}
  DATABASE_USER: ${DATABASE_USER:-postgres}
  DATABASE_PASSWORD: ${DATABASE_PASSWORD}
  CLICKHOUSE_HOST: ${CLICKHOUSE_HOST:-http://clickhouse-server:8123}
  TEMPORAL_ADDRESS: ${TEMPORAL_ADDRESS:-temporal:7233}
  WORKSPACE_NAME: ${WORKSPACE_NAME:-Default}
  AUTH_MODE: ${AUTH_MODE:-single-tenant}
  SECRET_KEY: ${SECRET_KEY}
  PASSWORD: ${PASSWORD}
  DASHBOARD_API_BASE: ${SERVICE_URL_LITE}
  ONBOARDING_URL: ${ONBOARDING_URL}
  
x-timezone: &default-timezone
  environment:
    - TZ=Asia/Kolkata
  volumes:
    - /etc/localtime:/etc/localtime:ro
    - /etc/timezone:/etc/timezone:ro


services:
  # Main Dittofeed Lite Application (with single-tenant auth)
  lite:
    <<: *default-timezone
    image: dittofeed/dittofeed-lite:${IMAGE_TAG:-v0.23.0}
    command: node --max-old-space-size=${MEM_LIMIT:-1024} ./packages/lite/dist/scripts/startLite.js --workspace-name=${WORKSPACE_NAME:-Default}
    restart: always
    environment:
      <<: *backend-app-env
      PORT: "3000"
      HOST: "0.0.0.0"
      BOOTSTRAP: ${BOOTSTRAP:-true}
    # Port binding removed - access only via Traefik reverse proxy
    # Traefik accesses via Docker network (container name: lite)
    # ports:
    #   - "3000:3000"
    depends_on:
      - postgres
      - temporal
      - clickhouse-server
    volumes:
      - ./mnt:/dittofeed-mnt
    networks:
      - dittofeed-network-lite
    labels:
      - "traefik.http.services.dittofeed-lite.loadbalancer.server.port=3000"
      - "traefik.http.routers.https-0-hs44k8wsko0c4ggwsgsg0ws0-lite.service=dittofeed-lite"
      - "traefik.http.routers.https-0-hs44k8wsko0c4ggwsgsg0ws0-lite.rule=PathPrefix(`/dashboard`) || PathPrefix(`/api`)"
      - "traefik.docker.network=hs44k8wsko0c4ggwsgsg0ws0"
    deploy:
      resources:
        limits:
          memory: ${CONTAINER_MEM_LIMIT:-1200}m

  # PostgreSQL Database
  postgres:
    <<: *default-timezone
    image: postgres:${POSTGRES_VERSION:-15}
    restart: always
    environment:
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD}
      POSTGRES_DB: dittofeed
      POSTGRES_USER: ${DATABASE_USER:-postgres}
    volumes:
      - dittofeed_postgres_data:/var/lib/postgresql/data
    networks:
      - dittofeed-network-lite
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DATABASE_USER:-postgres} -d dittofeed"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ClickHouse for analytics
  clickhouse-server:
    image: clickhouse/clickhouse-server:24.12.6.70-alpine
    restart: always
    environment:
      <<: *clickhouse-credentials
    ports:
      - "8123:8123"
    volumes:
      - dittofeed_clickhouse_data:/var/lib/clickhouse
      - dittofeed_clickhouse_logs:/var/log/clickhouse-server
    networks:
      - dittofeed-network-lite
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: ${CLICKHOUSE_CONTAINER_MEM_LIMIT:-3072}m

  # Temporal for workflow management
  temporal:
    image: temporalio/auto-setup:${TEMPORAL_VERSION:-1.22.4}
    restart: always
    depends_on:
      - postgres
    environment:
      - DB=postgresql
      - DB_PORT=${DATABASE_PORT:-5432}
      - POSTGRES_USER=${DATABASE_USER:-postgres}
      - POSTGRES_PWD=${DATABASE_PASSWORD}
      - POSTGRES_SEEDS=${DATABASE_HOST:-postgres}
      - TEMPORAL_CLI_SHOW_STACKS=1
      - POSTGRES_DB_NAME=temporal
      - BIND_ON_IP=0.0.0.0
      - TEMPORAL_BROADCAST_ADDRESS=temporal:7233
    networks:
      - dittofeed-network-lite
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:7233/api/v1/system/health || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Temporal UI (for workflow monitoring)
  temporal-ui:
    image: temporalio/ui:${TEMPORAL_UI_VERSION:-2.22.1}
    restart: always
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_CORS_ORIGINS=https://dittofeed.shortcastle.com
    depends_on:
      - temporal
    networks:
      - dittofeed-network-lite

  # Admin CLI for maintenance operations
  admin-cli:
    image: dittofeed/dittofeed-admin-cli:${IMAGE_TAG:-v0.23.0}
    entrypoint: ["tail", "-f", "/dev/null"]
    depends_on:
      - postgres
      - temporal
      - clickhouse-server
    environment:
      <<: *backend-app-env
    volumes:
      - ./mnt:/dittofeed-mnt
    networks:
      - dittofeed-network-lite

volumes:
  # Shared volumes for easy EE migration
  dittofeed_postgres_data:
  dittofeed_clickhouse_data:
  dittofeed_clickhouse_logs:

networks:
  dittofeed-network-lite:
    driver: bridge
    name: dittofeed-network-lite
